{% extends "layout.html" %}

{% block title %}
    HomePage
{% endblock %}

{% block main %}
<div class="d-flex justify-content-between align-items-center">
    <div class="bg-white p-5 rounded-4 mx-auto text-azul fw-bold text-center" style="max-width: 680px; max-height: 70vh;">
        <p class="bg-secundario rounded-4 px-3 py-2 fs-3">Insira sua senha para acompanhar a fila de forma remota!</p>
        <!-- O formulário não é estritamente necessário para o autocomplete, mas é bom tê-lo -->
        <div id="searchForm" class="d-flex gap-5 justify-content-center align-items-center py-3" action="/sua-url-de-busca-final/" method="get" autocomplete="off">
            <p class="my-auto fs-3">digite aqui:</p>
            <div class="position-relative">
              <input type="text" class="bg-cinza rounded-3 border-0 fs-3 w-100" id="searchInput" name="q" placeholder="">
              <div id="suggestions-box" class="position-absolute rounded-3 w-100"></div>
            </div>
        </div>
        
    </div>

    <div class="d-flex flex-column align-items-stretch flex-shrink-0 bg-body-tertiary overflow-auto" style="width: 380px; height: 80vh;">


        <div class="d-flex align-items-center flex-shrink-0 p-3 link-body-emphasis text-decoration-none border-bottom">
            <span class="fs-5 fw-semibold">Numeros chamados</span>
        </div>
    
    
        <div class="list-group list-group-flush border-bottom scrollarea">
    
            {% for code in codes %}
            <div class="list-group-item list-group-item-danger py-3 lh-sm" aria-current="true" onclick="acompanhar('{{ code.id }}')">
                <div class="d-flex w-100 align-items-center justify-content-between">
                    <strong class="mb-1">{{ code.code }}</strong>
                    <small>{{ code.type_of_code }}</small>
                </div>
                <div class="col-10 mb-1 small">{{ code.created }}</div>
            </div>
            {% endfor %} 
        </div>
    
    
    </div>
</div>


<script type="text/javascript">
    const socket = new WebSocket('ws://' + window.location.host + '/ws/codes/');

    socket.onmessage = function(e) {

        const data = JSON.parse(e.data);

        console.log(data)
        console.log('Mensagem recebida do WebSocket:', data);

        const container = document.querySelector('.list-group');
        
        const codeItem = document.createElement('div');
        codeItem.className = 'list-group-item list-group-item-danger py-3 lh-sm';
        codeItem.innerHTML = `
            <div class="d-flex w-100 align-items-center justify-content-between">
                <strong class="mb-1">${data.code}</strong>
                <small>${data.type_of_code}</small>
            </div>
            <div class="col-10 mb-1 small">${formatDate(data.created)}</div>
        `;

        container.prepend(codeItem); // Add new item to the top
    };


    function formatDate(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        }).replace('AM', 'a.m.').replace('PM', 'p.m.');
    };
    
    function acompanhar(id) {
      // alert(id)
      window.location.href = `/fila/${id}`;
    }

    const searchInput = document.getElementById('searchInput');
    const suggestionsBox = document.getElementById('suggestions-box');
    
    const searchUrl = "{% url 'search_senhas' %}";

    searchInput.addEventListener('keyup', function() {
        const term = searchInput.value;

        if (term.length < 1) {
            suggestionsBox.innerHTML = '';
            return;
        }
            
        const urlWithParams = `${searchUrl}?term=${term}`;

        console.log("Buscando em:", urlWithParams);

        fetch(urlWithParams)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`A resposta da rede não foi 'ok'. Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                suggestionsBox.innerHTML = '';

                data.senhas.forEach(paciente => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item d-flex justify-content-around border border-1 rounded-3 bg-white';
                    div.innerHTML = `<p class="my-auto py-1">${paciente.code}</p>
                    <p class="my-auto py-1">${paciente.status}</p>
                    <p class="my-auto py-1">${paciente.preferencial}</p>`
                    
                    div.addEventListener('click', function() {
                      window.location.href = `/fila/${paciente.id}`;
                    });

                    suggestionsBox.appendChild(div);
                });
            })
            .catch(error => {
                console.error('Erro ao buscar sugestões:', error);
                suggestionsBox.innerHTML = `<div class="suggestion-item" style="color: red;">Erro ao buscar.</div>`;
            });
    });

    document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target)) {
            suggestionsBox.innerHTML = '';
        }
    });

    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
    });
</script>

{% endblock %}