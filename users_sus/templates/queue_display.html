{# users_sus/templates/queue_display.html #}
{% extends "layout.html" %}
{% load static %}

{% block title %}
    Fila de Atendimento - {{ health_unit.name|default:"Unidade" }}
{% endblock %}

{% block main %}
<div class="container-fluid min-vh-100 d-flex flex-column align-items-center justify-content-center text-center py-5 queue-display-wrapper">

    {% if error %}
        <div class="alert alert-danger" role="alert">
            {{ error }}
        </div>
    {% endif %}

    {% if health_unit %}
        <h1 class="display-3 fw-bold mb-4 queue-title">{{ health_unit.name }}</h1>

        <div class="row w-100 align-items-start justify-content-center">
            {# COLUNA DA ESQUERDA: Senha Atual #}
            <div class="col-12 col-md-6 mb-4 d-flex justify-content-center">
                <div class="card p-4 shadow-lg current-code-card">
                    <div class="card-body">
                        <h2 class="card-title display-5 mb-4 text-primary fw-bold">SENHA ATUAL</h2>
                        <div id="current-calling-display">
                            {% if calling_code %}
                                <p class="display-1 fw-bolder text-info current-code-number">
                                    {{ calling_code.get_type_of_code_display|slice:"0" }}{{ calling_code.code }}
                                </p>
                                <p class="lead text-muted">
                                    Chamando... ({{ calling_code.get_type_of_code_display }})
                                </p>
                            {% else %}
                                <p class="display-3 text-secondary no-current-code">Aguardando Chamada</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# COLUNA DA DIREITA: Últimas Senhas Chamadas #}
            <div class="col-12 col-md-6 mb-4 d-flex justify-content-center">
                <div class="card p-4 shadow-lg last-called-card">
                    <div class="card-body">
                        <h3 class="card-title text-secondary mb-3">Últimas Chamadas</h3>
                        <div id="last-called-list" class="d-flex flex-column align-items-center">
                            {% for code in last_called_or_attended_codes %}
                                <div class="mb-2 w-75">
                                    <span class="badge bg-secondary p-3 last-code-badge d-block">
                                        {{ code.get_type_of_code_display|slice:"0" }}{{ code.code }}
                                    </span>
                                </div>
                            {% empty %}
                                <p class="text-muted">Nenhuma senha chamada recentemente.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Script para o WebSocket #}
        <script>
            const HEALTH_UNIT_ID = "{{ health_unit.id }}"; 

            let queueSocket;

            function connectWebSocket() {
                if (queueSocket && queueSocket.readyState === WebSocket.OPEN) {
                    return;
                }
                queueSocket = new WebSocket(`ws://${window.location.host}/ws/queue/${HEALTH_UNIT_ID}/`);

                queueSocket.onopen = function(e) {
                    console.log("QUEUE_DISPLAY: WebSocket conectado à fila da unidade:", HEALTH_UNIT_ID);
                };

                queueSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    console.log('QUEUE_DISPLAY: Mensagem WebSocket recebida:', data);
                    location.reload(); 
                };

                queueSocket.onclose = function(e) {
                    console.error('QUEUE_DISPLAY: WebSocket desconectado, tentando reconectar...');
                    setTimeout(connectWebSocket, 1000);
                };

                queueSocket.onerror = function(e) {
                    console.error('QUEUE_DISPLAY: WebSocket erro:', e);
                };
            }

            document.addEventListener('DOMContentLoaded', connectWebSocket);
        </script>

    {% else %}
        <p class="lead">Nenhuma unidade de saúde encontrada. Por favor, contate o administrador.</p>
    {% endif %}
</div>
{% endblock %}